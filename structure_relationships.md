# cATæ¡†æ¶ç»“æ„ä½“å…³ç³»è¯¦è§£

## ğŸ“Š ç»“æ„ä½“å±‚æ¬¡å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    cat_descriptor                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  cmd_group (æ•°ç»„æŒ‡é’ˆ)                                  â”‚ â”‚
â”‚  â”‚  cmd_group_num (æ•°é‡)                                  â”‚ â”‚
â”‚  â”‚  buf (å·¥ä½œç¼“å†²åŒº)                                      â”‚ â”‚
â”‚  â”‚  buf_size                                              â”‚ â”‚
â”‚  â”‚  unsolicited_buf                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ åŒ…å«
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  cat_command_group                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  name (ç»„å)                                           â”‚ â”‚
â”‚  â”‚  cmd (å‘½ä»¤æ•°ç»„æŒ‡é’ˆ)                                    â”‚ â”‚
â”‚  â”‚  cmd_num (å‘½ä»¤æ•°é‡)                                    â”‚ â”‚
â”‚  â”‚  disable (ç¦ç”¨æ ‡å¿—)                                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ åŒ…å«å¤šä¸ª
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    cat_command                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  name (å‘½ä»¤å: "+PRINT")                              â”‚ â”‚
â”‚  â”‚  description (æè¿°)                                   â”‚ â”‚
â”‚  â”‚  write/read/run/test (å›è°ƒå‡½æ•°)                       â”‚ â”‚
â”‚  â”‚  var (å˜é‡æ•°ç»„æŒ‡é’ˆ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚ â”‚
â”‚  â”‚  var_num (å˜é‡æ•°é‡)                 â”‚                â”‚ â”‚
â”‚  â”‚  need_all_vars                      â”‚                â”‚ â”‚
â”‚  â”‚  only_test/disable                 â”‚                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚ åŒ…å«å¤šä¸ª
                                         â†“
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚    cat_variable              â”‚
                           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                           â”‚  â”‚ name ("X", "Y", "MSG")   â”‚ â”‚
                           â”‚  â”‚ type (INT/UINT/STRING)   â”‚ â”‚
                           â”‚  â”‚ data (æ•°æ®æŒ‡é’ˆ)          â”‚ â”‚
                           â”‚  â”‚ data_size                â”‚ â”‚
                           â”‚  â”‚ access (READ/WRITE)      â”‚ â”‚
                           â”‚  â”‚ write/read (å›è°ƒ)        â”‚ â”‚
                           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”— è¯¦ç»†å…³ç³»åˆ†æ

### 1. cat_variable (å˜é‡)

**ä½œç”¨**: å®šä¹‰å•ä¸ªå‘½ä»¤å‚æ•°çš„æ•°æ®ç»“æ„

```c
struct cat_variable {
    const char *name;              // å˜é‡åç§°
    cat_var_type type;             // æ•°æ®ç±»å‹
    void *data;                    // æ•°æ®æŒ‡é’ˆ
    size_t data_size;              // æ•°æ®å¤§å°
    cat_var_access access;         // è®¿é—®æƒé™
    cat_var_write_handler write;   // å†™å…¥å›è°ƒ
    cat_var_read_handler read;     // è¯»å–å›è°ƒ
};
```

**ç¤ºä¾‹**:
```c
static uint8_t x = 0;
static struct cat_variable x_var = {
    .name = "X",
    .type = CAT_VAR_UINT_DEC,
    .data = &x,                    // æŒ‡å‘å®é™…æ•°æ®
    .data_size = sizeof(x),
    .access = CAT_VAR_ACCESS_READ_WRITE,
};
```

### 2. cat_command (å‘½ä»¤)

**ä½œç”¨**: å®šä¹‰ä¸€ä¸ªATå‘½ä»¤åŠå…¶å…³è”çš„å˜é‡

```c
struct cat_command {
    const char *name;                      // å‘½ä»¤å
    const char *description;              // æè¿°
    cat_cmd_write_handler write;          // WRITEå›è°ƒ
    cat_cmd_read_handler read;            // READå›è°ƒ
    cat_cmd_run_handler run;              // RUNå›è°ƒ
    cat_cmd_test_handler test;            // TESTå›è°ƒ
    struct cat_variable const *var;       // å˜é‡æ•°ç»„
    size_t var_num;                       // å˜é‡æ•°é‡
    bool need_all_vars;                   // æ˜¯å¦éœ€è¦æ‰€æœ‰å˜é‡
    bool only_test;                       // ä»…æµ‹è¯•
    bool disable;                         // ç¦ç”¨
    bool implicit_write;                  // éšå¼å†™å…¥
};
```

**å…³é”®å…³ç³»**:
- ä¸€ä¸ªå‘½ä»¤åŒ…å«0åˆ°å¤šä¸ªå˜é‡
- é€šè¿‡`var`æŒ‡é’ˆå¼•ç”¨å˜é‡æ•°ç»„
- é€šè¿‡`var_num`æŒ‡å®šå˜é‡æ•°é‡

**ç¤ºä¾‹**:
```c
static struct cat_variable print_vars[] = {
    { .name = "X", ... },
    { .name = "Y", ... },
    { .name = "MESSAGE", ... }
};

static struct cat_command print_cmd = {
    .name = "+PRINT",
    .description = "Print at (X,Y)",
    .var = print_vars,            // å…³è”å˜é‡æ•°ç»„
    .var_num = 3,                 // 3ä¸ªå˜é‡
    .need_all_vars = true
};
```

### 3. cat_command_group (å‘½ä»¤ç»„)

**ä½œç”¨**: å°†å¤šä¸ªå‘½ä»¤ç»„ç»‡åœ¨ä¸€èµ·

```c
struct cat_command_group {
    const char *name;                      // ç»„å
    struct cat_command const *cmd;        // å‘½ä»¤æ•°ç»„
    size_t cmd_num;                        // å‘½ä»¤æ•°é‡
    bool disable;                          // ç¦ç”¨æ•´ç»„
};
```

**å…³é”®å…³ç³»**:
- ä¸€ä¸ªå‘½ä»¤ç»„åŒ…å«å¤šä¸ªå‘½ä»¤
- é€šè¿‡`cmd`æŒ‡é’ˆå¼•ç”¨å‘½ä»¤æ•°ç»„
- å¯ä»¥æ‰¹é‡ç¦ç”¨æ•´ç»„å‘½ä»¤

**ç¤ºä¾‹**:
```c
static struct cat_command cmds[] = {
    { .name = "+PRINT", ... },
    { .name = "#HELP", ... },
    { .name = "#QUIT", ... }
};

static struct cat_command_group cmd_group = {
    .name = "print_commands",
    .cmd = cmds,                  // å…³è”å‘½ä»¤æ•°ç»„
    .cmd_num = 3                   // 3ä¸ªå‘½ä»¤
};
```

### 4. cat_descriptor (è§£æå™¨æè¿°ç¬¦)

**ä½œç”¨**: é¡¶å±‚é…ç½®ï¼ŒåŒ…å«æ‰€æœ‰å‘½ä»¤ç»„å’Œç¼“å†²åŒº

```c
struct cat_descriptor {
    struct cat_command_group* const *cmd_group;  // å‘½ä»¤ç»„æ•°ç»„
    size_t cmd_group_num;                        // ç»„æ•°é‡
    uint8_t *buf;                                // å·¥ä½œç¼“å†²åŒº
    size_t buf_size;                             // ç¼“å†²åŒºå¤§å°
    uint8_t *unsolicited_buf;                    // Unsolicitedç¼“å†²åŒº
    size_t unsolicited_buf_size;                 // Unsolicitedå¤§å°
};
```

**å…³é”®å…³ç³»**:
- åŒ…å«å¤šä¸ªå‘½ä»¤ç»„
- æä¾›å·¥ä½œç¼“å†²åŒº
- æ˜¯æ¡†æ¶çš„æ ¹é…ç½®

**ç¤ºä¾‹**:
```c
static struct cat_command_group *groups[] = {
    &cmd_group
};

static struct cat_descriptor desc = {
    .cmd_group = groups,          // å‘½ä»¤ç»„æ•°ç»„
    .cmd_group_num = 1,            // 1ä¸ªç»„
    .buf = buf,                    // å·¥ä½œç¼“å†²åŒº
    .buf_size = sizeof(buf)
};
```

## ğŸ“ˆ å®Œæ•´æ•°æ®æµç¤ºä¾‹

```c
// 1. å®šä¹‰åº”ç”¨æ•°æ®
static uint8_t x = 0, y = 0;
static char msg[16] = "";

// 2. å®šä¹‰å˜é‡
static struct cat_variable print_vars[] = {
    {.name = "X", .type = CAT_VAR_UINT_DEC, .data = &x, ...},
    {.name = "Y", .type = CAT_VAR_UINT_DEC, .data = &y, ...},
    {.name = "MSG", .type = CAT_VAR_BUF_STRING, .data = msg, ...}
};

// 3. å®šä¹‰å‘½ä»¤
static struct cat_command cmds[] = {
    {.name = "+PRINT", .var = print_vars, .var_num = 3, ...},
    {.name = "#HELP", ...}
};

// 4. å®šä¹‰å‘½ä»¤ç»„
static struct cat_command_group cmd_group = {
    .cmd = cmds,
    .cmd_num = 2
};

// 5. å®šä¹‰æè¿°ç¬¦
static char buf[128];
static struct cat_command_group *groups[] = {&cmd_group};
static struct cat_descriptor desc = {
    .cmd_group = groups,
    .cmd_group_num = 1,
    .buf = buf,
    .buf_size = sizeof(buf)
};
```

## ğŸ¯ å…³ç³»æ€»ç»“

| ç»“æ„ä½“ | åŒ…å« | å±‚æ¬¡ | ä½œç”¨ |
|--------|------|------|------|
| cat_descriptor | cat_command_group[] | æœ€é«˜ | å…¨å±€é…ç½® |
| cat_command_group | cat_command[] | é«˜ | å‘½ä»¤åˆ†ç»„ |
| cat_command | cat_variable[] | ä¸­ | å•æ¡å‘½ä»¤ |
| cat_variable | - | æœ€ä½ | å•ä¸ªå‚æ•° |

## ğŸ’¡ å…³é”®è¦ç‚¹

1. **åˆ†å±‚ç»„ç»‡**: descriptor â†’ command_group â†’ command â†’ variable
2. **æ•°ç»„å¼•ç”¨**: æ¯å±‚éƒ½ä½¿ç”¨æ•°ç»„æŒ‡é’ˆå¼•ç”¨ä¸‹å±‚æ•°ç»„
3. **çµæ´»é…ç½®**: å¯ä»¥ç¦ç”¨å‘½ä»¤ã€å‘½ä»¤ç»„
4. **æ•°æ®ç»‘å®š**: variableé€šè¿‡dataæŒ‡é’ˆç»‘å®šåº”ç”¨æ•°æ®
5. **å›è°ƒå…³è”**: commandå’Œvariableéƒ½å¯å®šä¹‰å›è°ƒå‡½æ•°

## ğŸ”„ åˆå§‹åŒ–æµç¨‹

```
1. å®šä¹‰åº”ç”¨æ•°æ®å˜é‡ (x, y, msg)
   â†“
2. åˆ›å»º cat_variable æ•°ç»„ (print_vars)
   â†“
3. åˆ›å»º cat_command æ•°ç»„ (cmds)
   â†“
4. åˆ›å»º cat_command_group (cmd_group)
   â†“
5. åˆ›å»º cat_descriptor (desc)
   â†“
6. è°ƒç”¨ cat_init(&obj, &desc, &io, &mutex)
```

